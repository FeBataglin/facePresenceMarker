import { __assign, __decorate, __metadata, __read, __spread } from "tslib";
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addZero, convertDateToISOExtended } from '../../utils/util';
var PoPageJobSchedulerService = /** @class */ (function () {
    function PoPageJobSchedulerService(http) {
        this.http = http;
        this.endpoint = '/';
        this.headers = new HttpHeaders({
            'X-PO-SCREEN-LOCK': 'true'
        });
    }
    PoPageJobSchedulerService.prototype.configServiceApi = function (config) {
        if (config === void 0) { config = {}; }
        this.endpoint = config.endpoint;
    };
    // Cria um recurso
    PoPageJobSchedulerService.prototype.createResource = function (resource) {
        var jobScheduler = this.convertToJobScheduler(resource);
        return this.http.post("" + this.endpoint, jobScheduler, { headers: this.headers });
    };
    PoPageJobSchedulerService.prototype.getHeadProcesses = function () {
        var headers = { 'X-PO-No-Error': 'true' };
        return this.http.head(this.endpoint + "/processes", { headers: headers });
    };
    // Busca parametros pelo processo id
    PoPageJobSchedulerService.prototype.getParametersByProcess = function (processId) {
        return this.http
            .get(this.endpoint + "/processes/" + processId + "/parameters", { headers: this.headers })
            .pipe(map(function (resource) { return resource.items; }));
    };
    // Busca um único recurso
    PoPageJobSchedulerService.prototype.getProcess = function (id) {
        return this.http.get(this.endpoint + "/processes/" + id, { headers: this.headers });
    };
    // Busca uma lista de processos
    PoPageJobSchedulerService.prototype.getProcesses = function (params) {
        if (params === void 0) { params = {}; }
        return this.http.get(this.endpoint + "/processes", { params: params });
    };
    // Busca um único recurso
    PoPageJobSchedulerService.prototype.getResource = function (id) {
        var _this = this;
        return this.http
            .get(this.endpoint + "/" + id, { headers: this.headers })
            .pipe(map(function (resource) { return _this.convertToJobSchedulerInternal(resource); }));
    };
    // Atualiza um recurso
    PoPageJobSchedulerService.prototype.updateResource = function (id, resource) {
        var jobScheduler = this.convertToJobScheduler(resource);
        return this.http.put(this.endpoint + "/" + id, jobScheduler, { headers: this.headers });
    };
    PoPageJobSchedulerService.prototype.convertToJobScheduler = function (jobSchedulerInternal) {
        var jobScheduler = __assign({}, jobSchedulerInternal);
        if (jobSchedulerInternal.periodicity) {
            if (jobSchedulerInternal.periodicity === 'single') {
                jobScheduler.recurrent = false;
            }
            else {
                Object.assign(jobScheduler, this.convertToPeriodicity(jobSchedulerInternal));
            }
        }
        if (jobSchedulerInternal.firstExecutionHour) {
            jobScheduler.firstExecution = this.replaceHourFirstExecution(jobSchedulerInternal.firstExecution, jobSchedulerInternal.firstExecutionHour);
        }
        if (!Object.keys(this.returnValidExecutionParameter(jobScheduler.executionParameter)).length) {
            delete jobScheduler.executionParameter;
        }
        this.removeInvalidKeys(jobScheduler);
        return jobScheduler;
    };
    PoPageJobSchedulerService.prototype.convertToJobSchedulerInternal = function (jobScheduler) {
        if (jobScheduler === void 0) { jobScheduler = {}; }
        var jobSchedulerInternal = __assign({}, jobScheduler);
        if (jobScheduler.firstExecution) {
            jobSchedulerInternal.firstExecutionHour = this.getHourFirstExecution(jobScheduler.firstExecution);
        }
        Object.assign(jobSchedulerInternal, this.convertToPeriodicityInternal(jobScheduler));
        this.removeInvalidKeys(jobSchedulerInternal, ['weekly', 'monthly', 'daily']);
        return jobSchedulerInternal;
    };
    PoPageJobSchedulerService.prototype.convertToPeriodicity = function (value) {
        var newValue = {};
        var valuePeriodicity = value.periodicity;
        if (valuePeriodicity) {
            newValue[valuePeriodicity] = {};
            if (valuePeriodicity === 'monthly') {
                newValue[valuePeriodicity].day = value.dayOfMonth ? parseInt(value.dayOfMonth, 10) : 0;
            }
            else if (valuePeriodicity === 'weekly') {
                newValue[valuePeriodicity].daysOfWeek = value.daysOfWeek;
            }
            newValue[valuePeriodicity].hour = value.hour ? parseInt(value.hour.split(':')[0], 10) : 0;
            newValue[valuePeriodicity].minute = value.hour ? parseInt(value.hour.split(':')[1], 10) : 0;
        }
        return newValue;
    };
    PoPageJobSchedulerService.prototype.convertToPeriodicityInternal = function (value) {
        if (value === void 0) { value = {}; }
        if (value.monthly) {
            return {
                periodicity: 'monthly',
                hour: addZero(value.monthly.hour) + ":" + addZero(value.monthly.minute),
                dayOfMonth: value.monthly.day
            };
        }
        else if (value.daily) {
            return {
                periodicity: 'daily',
                hour: addZero(value.daily.hour) + ":" + addZero(value.daily.minute)
            };
        }
        else if (value.weekly) {
            return {
                periodicity: 'weekly',
                hour: addZero(value.weekly.hour) + ":" + addZero(value.weekly.minute),
                daysOfWeek: __spread(value.weekly.daysOfWeek)
            };
        }
        else {
            return {
                periodicity: 'single'
            };
        }
    };
    PoPageJobSchedulerService.prototype.getCurrentHour = function (date) {
        var hours = addZero(date.getHours());
        var minutes = addZero(date.getMinutes());
        return hours + ":" + minutes;
    };
    PoPageJobSchedulerService.prototype.getHourFirstExecution = function (firstExecutionDate) {
        return this.getCurrentHour(new Date(firstExecutionDate));
    };
    PoPageJobSchedulerService.prototype.removeInvalidKeys = function (value, keys) {
        var invalidKeys = keys || [
            'periodicity',
            'hour',
            'minute',
            'day',
            'daysOfWeek',
            'dayOfMonth',
            'firstExecutionHour'
        ];
        Object.keys(value).forEach(function (key) {
            if (invalidKeys.includes(key)) {
                delete value[key];
            }
        });
    };
    PoPageJobSchedulerService.prototype.replaceHourFirstExecution = function (date, time) {
        var firstExecutionDate = new Date(date);
        var timeSplited = time.split(':');
        var hours = parseInt(timeSplited[0], 10);
        var minutes = parseInt(timeSplited[1], 10);
        firstExecutionDate.setHours(hours, minutes);
        return convertDateToISOExtended(firstExecutionDate);
    };
    PoPageJobSchedulerService.prototype.returnValidExecutionParameter = function (parameter) {
        var newParameter = __assign({}, parameter);
        for (var key in newParameter) {
            if (newParameter.hasOwnProperty(key) && newParameter[key] === undefined) {
                delete newParameter[key];
            }
        }
        return newParameter;
    };
    PoPageJobSchedulerService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    PoPageJobSchedulerService = __decorate([
        Injectable(),
        __metadata("design:paramtypes", [HttpClient])
    ], PoPageJobSchedulerService);
    return PoPageJobSchedulerService;
}());
export { PoPageJobSchedulerService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcGFnZS1qb2Itc2NoZWR1bGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG8tdWkvbmctdGVtcGxhdGVzLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tcGFnZS1qb2Itc2NoZWR1bGVyL3BvLXBhZ2Utam9iLXNjaGVkdWxlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQU9yRTtJQU9FLG1DQUFvQixJQUFnQjtRQUFoQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBTjVCLGFBQVEsR0FBRyxHQUFHLENBQUM7UUFFZCxZQUFPLEdBQWdCLElBQUksV0FBVyxDQUFDO1lBQzlDLGtCQUFrQixFQUFFLE1BQU07U0FDM0IsQ0FBQyxDQUFDO0lBRW9DLENBQUM7SUFFeEMsb0RBQWdCLEdBQWhCLFVBQWlCLE1BQWtDO1FBQWxDLHVCQUFBLEVBQUEsV0FBa0M7UUFDakQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUFFRCxrQkFBa0I7SUFDbEIsa0RBQWMsR0FBZCxVQUFlLFFBQVE7UUFDckIsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTFELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBRyxJQUFJLENBQUMsUUFBVSxFQUFFLFlBQVksRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUNyRixDQUFDO0lBRUQsb0RB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Q0FBQyxHQUFHLENBQUMsQ0FBQzthQUNuQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLDZEQUF5QixHQUFqQyxVQUFrQyxJQUFZLEVBQUUsSUFBWTtRQUMxRCxJQUFNLGtCQUFrQixHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTFDLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEMsSUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMzQyxJQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTdDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFNUMsT0FBTyx3QkFBd0IsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFTyxpRUFBNkIsR0FBckMsVUFBc0MsU0FBaUI7UUFDckQsSUFBTSxZQUFZLGdCQUFRLFNBQVMsQ0FBRSxDQUFDO1FBRXRDLEtBQUssSUFBTSxHQUFHLElBQUksWUFBWSxFQUFFO1lBQzlCLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxZQUFZLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxFQUFFO2dCQUN2RSxPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxQjtTQUNGO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQzs7Z0JBak15QixVQUFVOztJQVB6Qix5QkFBeUI7UUFEckMsVUFBVSxFQUFFO3lDQVFlLFVBQVU7T0FQekIseUJBQXlCLENBeU1yQztJQUFELGdDQUFDO0NBQUEsQUF6TUQsSUF5TUM7U0F6TVkseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgYWRkWmVybywgY29udmVydERhdGVUb0lTT0V4dGVuZGVkIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXRpbCc7XG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtRmllbGQgfSBmcm9tICdAcG8tdWkvbmctY29tcG9uZW50cyc7XG5cbmltcG9ydCB7IFBvSm9iU2NoZWR1bGVyIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3BvLWpvYi1zY2hlZHVsZXIuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvSm9iU2NoZWR1bGVySW50ZXJuYWwgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tam9iLXNjaGVkdWxlci1pbnRlcm5hbC5pbnRlcmZhY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUG9QYWdlSm9iU2NoZWR1bGVyU2VydmljZSB7XG4gIHByaXZhdGUgZW5kcG9pbnQgPSAnLyc7XG5cbiAgcmVhZG9ubHkgaGVhZGVyczogSHR0cEhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoe1xuICAgICdYLVBPLVNDUkVFTi1MT0NLJzogJ3RydWUnXG4gIH0pO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge31cblxuICBjb25maWdTZXJ2aWNlQXBpKGNvbmZpZzogeyBlbmRwb2ludD86IHN0cmluZyB9ID0ge30pIHtcbiAgICB0aGlzLmVuZHBvaW50ID0gY29uZmlnLmVuZHBvaW50O1xuICB9XG5cbiAgLy8gQ3JpYSB1bSByZWN1cnNvXG4gIGNyZWF0ZVJlc291cmNlKHJlc291cmNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBqb2JTY2hlZHVsZXIgPSB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlcihyZXNvdXJjZSk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QoYCR7dGhpcy5lbmRwb2ludH1gLCBqb2JTY2hlZHVsZXIsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xuICB9XG5cbiAgZ2V0SGVhZFByb2Nlc3NlcygpIHtcbiAgICBjb25zdCBoZWFkZXJzID0geyAnWC1QTy1Oby1FcnJvcic6ICd0cnVlJyB9O1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5oZWFkKGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlc2AsIHsgaGVhZGVycyB9KTtcbiAgfVxuXG4gIC8vIEJ1c2NhIHBhcmFtZXRyb3MgcGVsbyBwcm9jZXNzbyBpZFxuICBnZXRQYXJhbWV0ZXJzQnlQcm9jZXNzKHByb2Nlc3NJZDogc3RyaW5nIHwgbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlcy8ke3Byb2Nlc3NJZH0vcGFyYW1ldGVyc2AsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pXG4gICAgICAucGlwZShtYXAoKHJlc291cmNlOiB7IGl0ZW1zOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+IH0pID0+IHJlc291cmNlLml0ZW1zKSk7XG4gIH1cblxuICAvLyBCdXNjYSB1bSDDum5pY28gcmVjdXJzb1xuICBnZXRQcm9jZXNzKGlkOiBzdHJpbmcgfCBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlcy8ke2lkfWAsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xuICB9XG5cbiAgLy8gQnVzY2EgdW1hIGxpc3RhIGRlIHByb2Nlc3Nvc1xuICBnZXRQcm9jZXNzZXMocGFyYW1zOiB7fSA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXNgLCB7IHBhcmFtcyB9KTtcbiAgfVxuXG4gIC8vIEJ1c2NhIHVtIMO6bmljbyByZWN1cnNvXG4gIGdldFJlc291cmNlKGlkOiBzdHJpbmcgfCBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KVxuICAgICAgLnBpcGUobWFwKHJlc291cmNlID0+IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVySW50ZXJuYWwocmVzb3VyY2UpKSk7XG4gIH1cblxuICAvLyBBdHVhbGl6YSB1bSByZWN1cnNvXG4gIHVwZGF0ZVJlc291cmNlKGlkLCByZXNvdXJjZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgam9iU2NoZWR1bGVyID0gdGhpcy5jb252ZXJ0VG9Kb2JTY2hlZHVsZXIocmVzb3VyY2UpO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCBqb2JTY2hlZHVsZXIsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9Kb2JTY2hlZHVsZXIoam9iU2NoZWR1bGVySW50ZXJuYWwpOiBQb0pvYlNjaGVkdWxlciB7XG4gICAgY29uc3Qgam9iU2NoZWR1bGVyID0geyAuLi5qb2JTY2hlZHVsZXJJbnRlcm5hbCB9O1xuXG4gICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLnBlcmlvZGljaXR5KSB7XG4gICAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucGVyaW9kaWNpdHkgPT09ICdzaW5nbGUnKSB7XG4gICAgICAgIGpvYlNjaGVkdWxlci5yZWN1cnJlbnQgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oam9iU2NoZWR1bGVyLCB0aGlzLmNvbnZlcnRUb1BlcmlvZGljaXR5KGpvYlNjaGVkdWxlckludGVybmFsKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91cikge1xuICAgICAgam9iU2NoZWR1bGVyLmZpcnN0RXhlY3V0aW9uID0gdGhpcy5yZXBsYWNlSG91ckZpcnN0RXhlY3V0aW9uKFxuICAgICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5maXJzdEV4ZWN1dGlvbixcbiAgICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghT2JqZWN0LmtleXModGhpcy5yZXR1cm5WYWxpZEV4ZWN1dGlvblBhcmFtZXRlcihqb2JTY2hlZHVsZXIuZXhlY3V0aW9uUGFyYW1ldGVyKSkubGVuZ3RoKSB7XG4gICAgICBkZWxldGUgam9iU2NoZWR1bGVyLmV4ZWN1dGlvblBhcmFtZXRlcjtcbiAgICB9XG5cbiAgICB0aGlzLnJlbW92ZUludmFsaWRLZXlzKGpvYlNjaGVkdWxlcik7XG5cbiAgICByZXR1cm4gam9iU2NoZWR1bGVyO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9Kb2JTY2hlZHVsZXJJbnRlcm5hbChqb2JTY2hlZHVsZXIgPSA8YW55Pnt9KTogUG9Kb2JTY2hlZHVsZXJJbnRlcm5hbCB7XG4gICAgY29uc3Qgam9iU2NoZWR1bGVySW50ZXJuYWwgPSB7IC4uLmpvYlNjaGVkdWxlciB9O1xuXG4gICAgaWYgKGpvYlNjaGVkdWxlci5maXJzdEV4ZWN1dGlvbikge1xuICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyID0gdGhpcy5nZXRIb3VyRmlyc3RFeGVjdXRpb24oam9iU2NoZWR1bGVyLmZpcnN0RXhlY3V0aW9uKTtcbiAgICB9XG5cbiAgICBPYmplY3QuYXNzaWduKGpvYlNjaGVkdWxlckludGVybmFsLCB0aGlzLmNvbnZlcnRUb1BlcmlvZGljaXR5SW50ZXJuYWwoam9iU2NoZWR1bGVyKSk7XG5cbiAgICB0aGlzLnJlbW92ZUludmFsaWRLZXlzKGpvYlNjaGVkdWxlckludGVybmFsLCBbJ3dlZWtseScsICdtb250aGx5JywgJ2RhaWx5J10pO1xuXG4gICAgcmV0dXJuIGpvYlNjaGVkdWxlckludGVybmFsO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9QZXJpb2RpY2l0eSh2YWx1ZToge1xuICAgIHBlcmlvZGljaXR5OiBzdHJpbmc7XG4gICAgZGF5T2ZNb250aD86IHN0cmluZztcbiAgICBkYXlzT2ZXZWVrPzogbnVtYmVyO1xuICAgIGhvdXI/OiBzdHJpbmc7XG4gIH0pIHtcbiAgICBjb25zdCBuZXdWYWx1ZSA9IHt9O1xuICAgIGNvbnN0IHZhbHVlUGVyaW9kaWNpdHkgPSB2YWx1ZS5wZXJpb2RpY2l0eTtcblxuICAgIGlmICh2YWx1ZVBlcmlvZGljaXR5KSB7XG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XSA9IHt9O1xuXG4gICAgICBpZiAodmFsdWVQZXJpb2RpY2l0eSA9PT0gJ21vbnRobHknKSB7XG4gICAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLmRheSA9IHZhbHVlLmRheU9mTW9udGggPyBwYXJzZUludCh2YWx1ZS5kYXlPZk1vbnRoLCAxMCkgOiAwO1xuICAgICAgfSBlbHNlIGlmICh2YWx1ZVBlcmlvZGljaXR5ID09PSAnd2Vla2x5Jykge1xuICAgICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5kYXlzT2ZXZWVrID0gdmFsdWUuZGF5c09mV2VlaztcbiAgICAgIH1cblxuICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uaG91ciA9IHZhbHVlLmhvdXIgPyBwYXJzZUludCh2YWx1ZS5ob3VyLnNwbGl0KCc6JylbMF0sIDEwKSA6IDA7XG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5taW51dGUgPSB2YWx1ZS5ob3VyID8gcGFyc2VJbnQodmFsdWUuaG91ci5zcGxpdCgnOicpWzFdLCAxMCkgOiAwO1xuICAgIH1cblxuICAgIHJldHVybiBuZXdWYWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydFRvUGVyaW9kaWNpdHlJbnRlcm5hbCh2YWx1ZSA9IDxhbnk+e30pIHtcbiAgICBpZiAodmFsdWUubW9udGhseSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdtb250aGx5JyxcbiAgICAgICAgaG91cjogYCR7YWRkWmVybyh2YWx1ZS5tb250aGx5LmhvdXIpfToke2FkZFplcm8odmFsdWUubW9udGhseS5taW51dGUpfWAsXG4gICAgICAgIGRheU9mTW9udGg6IHZhbHVlLm1vbnRobHkuZGF5XG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodmFsdWUuZGFpbHkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBlcmlvZGljaXR5OiAnZGFpbHknLFxuICAgICAgICBob3VyOiBgJHthZGRaZXJvKHZhbHVlLmRhaWx5LmhvdXIpfToke2FkZFplcm8odmFsdWUuZGFpbHkubWludXRlKX1gXG4gICAgICB9O1xuICAgIH0gZWxzZSBpZiAodmFsdWUud2Vla2x5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwZXJpb2RpY2l0eTogJ3dlZWtseScsXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUud2Vla2x5LmhvdXIpfToke2FkZFplcm8odmFsdWUud2Vla2x5Lm1pbnV0ZSl9YCxcbiAgICAgICAgZGF5c09mV2VlazogWy4uLnZhbHVlLndlZWtseS5kYXlzT2ZXZWVrXVxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdzaW5nbGUnXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q3VycmVudEhvdXIoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XG4gICAgY29uc3QgaG91cnMgPSBhZGRaZXJvKGRhdGUuZ2V0SG91cnMoKSk7XG4gICAgY29uc3QgbWludXRlcyA9IGFkZFplcm8oZGF0ZS5nZXRNaW51dGVzKCkpO1xuXG4gICAgcmV0dXJuIGAke2hvdXJzfToke21pbnV0ZXN9YDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SG91ckZpcnN0RXhlY3V0aW9uKGZpcnN0RXhlY3V0aW9uRGF0ZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50SG91cihuZXcgRGF0ZShmaXJzdEV4ZWN1dGlvbkRhdGUpKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlSW52YWxpZEtleXModmFsdWU6IG9iamVjdCwga2V5cz86IEFycmF5PHN0cmluZz4pIHtcbiAgICBjb25zdCBpbnZhbGlkS2V5cyA9IGtleXMgfHwgW1xuICAgICAgJ3BlcmlvZGljaXR5JyxcbiAgICAgICdob3VyJyxcbiAgICAgICdtaW51dGUnLFxuICAgICAgJ2RheScsXG4gICAgICAnZGF5c09mV2VlaycsXG4gICAgICAnZGF5T2ZNb250aCcsXG4gICAgICAnZmlyc3RFeGVjdXRpb25Ib3VyJ1xuICAgIF07XG5cbiAgICBPYmplY3Qua2V5cyh2YWx1ZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKGludmFsaWRLZXlzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgZGVsZXRlIHZhbHVlW2tleV07XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlcGxhY2VIb3VyRmlyc3RFeGVjdXRpb24oZGF0ZTogc3RyaW5nLCB0aW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGZpcnN0RXhlY3V0aW9uRGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuXG4gICAgY29uc3QgdGltZVNwbGl0ZWQgPSB0aW1lLnNwbGl0KCc6Jyk7XG5cbiAgICBjb25zdCBob3VycyA9IHBhcnNlSW50KHRpbWVTcGxpdGVkWzBdLCAxMCk7XG4gICAgY29uc3QgbWludXRlcyA9IHBhcnNlSW50KHRpbWVTcGxpdGVkWzFdLCAxMCk7XG5cbiAgICBmaXJzdEV4ZWN1dGlvbkRhdGUuc2V0SG91cnMoaG91cnMsIG1pbnV0ZXMpO1xuXG4gICAgcmV0dXJuIGNvbnZlcnREYXRlVG9JU09FeHRlbmRlZChmaXJzdEV4ZWN1dGlvbkRhdGUpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXR1cm5WYWxpZEV4ZWN1dGlvblBhcmFtZXRlcihwYXJhbWV0ZXI6IG9iamVjdCkge1xuICAgIGNvbnN0IG5ld1BhcmFtZXRlciA9IHsgLi4ucGFyYW1ldGVyIH07XG5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBuZXdQYXJhbWV0ZXIpIHtcbiAgICAgIGlmIChuZXdQYXJhbWV0ZXIuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBuZXdQYXJhbWV0ZXJba2V5XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGRlbGV0ZSBuZXdQYXJhbWV0ZXJba2V5XTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3UGFyYW1ldGVyO1xuICB9XG59XG4iXX0=