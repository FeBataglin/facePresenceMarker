import { __assign, __decorate, __extends, __metadata, __read, __spread } from "tslib";
import { Component, ViewChild, OnInit, OnDestroy, ChangeDetectorRef } from '@angular/core';
import { PoDisclaimerGroup, PoDynamicFieldType, PoDynamicFormField, PoLanguageService, PoPageFilter, PoDisclaimerGroupRemoveAction } from '@po-ui/ng-components';
import { capitalizeFirstLetter, getBrowserLanguage } from '../../utils/util';
import { PoPageCustomizationService } from '../../services/po-page-customization/po-page-customization.service';
import { PoAdvancedFilterComponent } from './po-advanced-filter/po-advanced-filter.component';
import { PoPageDynamicSearchBaseComponent } from './po-page-dynamic-search-base.component';
/**
 * @docsExtends PoPageDynamicSearchBaseComponent
 *
 * @example
 *
 * <example name="po-page-dynamic-search-basic" title="PO Page Dynamic Search Basic">
 *  <file name="sample-po-page-dynamic-search-basic/sample-po-page-dynamic-search-basic.component.html"> </file>
 *  <file name="sample-po-page-dynamic-search-basic/sample-po-page-dynamic-search-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-page-dynamic-search-hiring-processes" title="PO Page Dynamic Search - Hiring processes">
 *  <file name="sample-po-page-dynamic-search-hiring-processes/sample-po-page-dynamic-search-hiring-processes.component.html"> </file>
 *  <file name="sample-po-page-dynamic-search-hiring-processes/sample-po-page-dynamic-search-hiring-processes.component.ts"> </file>
 *  <file name="sample-po-page-dynamic-search-hiring-processes/sample-po-page-dynamic-search-hiring-processes.service.ts"> </file>
 * </example>
 */
var PoPageDynamicSearchComponent = /** @class */ (function (_super) {
    __extends(PoPageDynamicSearchComponent, _super);
    function PoPageDynamicSearchComponent(languageService, poPageCustomizationService, changeDetector) {
        var _this = _super.call(this, languageService) || this;
        _this.poPageCustomizationService = poPageCustomizationService;
        _this.changeDetector = changeDetector;
        _this._disclaimerGroup = {
            remove: _this.onRemoveDisclaimer.bind(_this),
            removeAll: _this.onRemoveAllDisclaimers.bind(_this),
            disclaimers: [],
            title: _this.literals.disclaimerGroupTitle
        };
        _this._filterSettings = {
            action: _this.onAction.bind(_this),
            advancedAction: _this.onAdvancedAction.bind(_this),
            placeholder: _this.literals.searchPlaceholder
        };
        return _this;
    }
    Object.defineProperty(PoPageDynamicSearchComponent.prototype, "disclaimerGroup", {
        get: function () {
            return Object.assign({}, this._disclaimerGroup, { title: this.literals.disclaimerGroupTitle });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoPageDynamicSearchComponent.prototype, "filterSettings", {
        get: function () {
            this._filterSettings.advancedAction = this.filters.length === 0 ? undefined : this.onAdvancedAction.bind(this);
            return Object.assign({}, this._filterSettings, { placeholder: this.literals.searchPlaceholder });
        },
        enumerable: true,
        configurable: true
    });
    PoPageDynamicSearchComponent.prototype.ngOnInit = function () {
        this.setAdvancedFilterLiterals(this.literals);
        if (this.onLoad) {
            this.loadOptionsOnInitialize(this.onLoad);
        }
    };
    PoPageDynamicSearchComponent.prototype.ngOnDestroy = function () {
        if (this.loadSubscription) {
            this.loadSubscription.unsubscribe();
        }
    };
    PoPageDynamicSearchComponent.prototype.onChangeFilters = function (filters) {
        var filterObjectWithValue = filters
            .filter(function (filter) { return filter.initValue; })
            .reduce(function (prev, current) {
            var _a;
            return __assign(__assign({}, prev), (_a = {}, _a[current.property] = current.initValue, _a));
        }, {});
        if (Object.keys(filterObjectWithValue).length) {
            this.onAdvancedSearch(filterObjectWithValue);
        }
    };
    PoPageDynamicSearchComponent.prototype.onAction = function (quickFilter) {
        var _this = this;
        var disclaimerQuickSearchUpdated = {
            property: 'search',
            label: this.literals.quickSearchLabel + " " + quickFilter,
            value: quickFilter
        };
        var getDisclaimersWithConcatFilters = function () { return __spread(_this.getDisclaimersWithoutQuickSearch(), [
            disclaimerQuickSearchUpdated
        ]); };
        this._disclaimerGroup.disclaimers = this.concatFilters
            ? getDisclaimersWithConcatFilters()
            : [disclaimerQuickSearchUpdated];
        if (this.quickSearch.observers && this.quickSearch.observers.length > 0) {
            this.quickSearch.emit(quickFilter);
        }
        if (this.keepFilters && !this.concatFilters) {
            this.filters.forEach(function (element) { return delete element.initValue; });
        }
        this.changeDetector.detectChanges();
    };
    PoPageDynamicSearchComponent.prototype.onAdvancedAction = function () {
        this.poAdvancedFilter.open();
    };
    PoPageDynamicSearchComponent.prototype.onAdvancedSearch = function (filters) {
        this._disclaimerGroup.disclaimers = this.setDisclaimers(filters);
        this.setFilters(filters);
        this.advancedSearch.emit(filters);
    };
    PoPageDynamicSearchComponent.prototype.getDisclaimersWithoutQuickSearch = function () {
        var quickSearchProperty = 'search';
        return this._disclaimerGroup.disclaimers.filter(function (item) { return item.property !== quickSearchProperty; });
    };
    PoPageDynamicSearchComponent.prototype.setFilters = function (filters) {
        var formattedFilters = this.convertToFilters(filters);
        this.filters.forEach(function (element) {
            var compatibleObject = formattedFilters.find(function (item) { return item.property === element.property; });
            if (compatibleObject) {
                element.initValue = compatibleObject.value;
            }
            else {
                delete element.initValue;
            }
        });
    };
    PoPageDynamicSearchComponent.prototype.convertToFilters = function (filters) {
        return Object.entries(filters).map(function (_a) {
            var _b = __read(_a, 2), property = _b[0], value = _b[1];
            return ({ property: property, value: value });
        });
    };
    PoPageDynamicSearchComponent.prototype.applyDisclaimerLabelValue = function (field, filterValue) {
        var values = Array.isArray(filterValue) ? filterValue : [filterValue];
        var labels = values.map(function (value) {
            var filteredField = field.options.find(function (option) { return option.value === value || option === value; });
            if (filteredField) {
                return filteredField.label || filteredField.value || filteredField;
            }
        });
        return labels.join(', ');
    };
    PoPageDynamicSearchComponent.prototype.formatDate = function (date) {
        var year = parseInt(date.substr(0, 4), 10);
        var month = parseInt(date.substr(5, 2), 10);
        var day = parseInt(date.substr(8, 2), 10);
        return new Date(year, month - 1, day).toLocaleDateString(getBrowserLanguage());
    };
    PoPageDynamicSearchComponent.prototype.formatArrayToObjectKeyValue = function (filters) {
        var formattedObject = filters.reduce(function (result, item) {
            var _a;
            return Object.assign(result, (_a = {}, _a[item.property] = item.value || item.initValue, _a));
        }, {});
        Object.keys(formattedObject).forEach(function (key) {
            if (!formattedObject[key]) {
                delete formattedObject[key];
            }
        });
        return formattedObject;
    };
    PoPageDynamicSearchComponent.prototype.getFieldByProperty = function (fields, fieldName) {
        return fields.find(function (field) { return field.property === fieldName; });
    };
    PoPageDynamicSearchComponent.prototype.getFilterValueToDisclaimer = function (field, value) {
        if (field.type === PoDynamicFieldType.Date) {
            return this.formatDate(value);
        }
        if (field.options && value) {
            return this.applyDisclaimerLabelValue(field, value);
        }
        return value;
    };
    PoPageDynamicSearchComponent.prototype.onRemoveDisclaimer = function (removeData) {
        var currentDisclaimers = removeData.currentDisclaimers;
        this.emitChangesDisclaimers(currentDisclaimers);
    };
    PoPageDynamicSearchComponent.prototype.emitChangesDisclaimers = function (currentDisclaimers) {
        this.changeDisclaimers.emit(currentDisclaimers);
        this.setFilters(this.formatArrayToObjectKeyValue(currentDisclaimers));
    };
    PoPageDynamicSearchComponent.prototype.onRemoveAllDisclaimers = function () {
        this.emitChangesDisclaimers([]);
    };
    PoPageDynamicSearchComponent.prototype.setDisclaimers = function (filters) {
        var _this = this;
        var disclaimers = [];
        var properties = Object.keys(filters);
        properties.forEach(function (property) {
            var field = _this.getFieldByProperty(_this.filters, property);
            var label = field.label || capitalizeFirstLetter(field.property);
            var value = filters[property];
            var valueDisplayedOnTheDisclaimerLabel = _this.getFilterValueToDisclaimer(field, value);
            if (valueDisplayedOnTheDisclaimerLabel !== '') {
                disclaimers.push({
                    label: label + ": " + valueDisplayedOnTheDisclaimerLabel,
                    property: property,
                    value: value
                });
            }
        });
        return disclaimers;
    };
    PoPageDynamicSearchComponent.prototype.loadOptionsOnInitialize = function (onLoad) {
        var _this = this;
        this.loadSubscription = this.getPoDynamicPageOptions(onLoad).subscribe(function (responsePoOption) {
            return _this.poPageCustomizationService.changeOriginalOptionsToNewOptions(_this, responsePoOption);
        });
    };
    PoPageDynamicSearchComponent.prototype.getPoDynamicPageOptions = function (onLoad) {
        var originalOption = {
            title: this.title,
            actions: this.actions,
            breadcrumb: this.breadcrumb,
            filters: this.filters,
            keepFilters: this.keepFilters,
            concatFilters: this.concatFilters
        };
        var pageOptionSchema = {
            schema: [
                {
                    nameProp: 'filters',
                    merge: true,
                    keyForMerge: 'property'
                },
                {
                    nameProp: 'actions',
                    merge: true,
                    keyForMerge: 'label'
                },
                {
                    nameProp: 'breadcrumb'
                },
                {
                    nameProp: 'title'
                },
                {
                    nameProp: 'keepFilters'
                },
                {
                    nameProp: 'concatFilters'
                }
            ]
        };
        return this.poPageCustomizationService.getCustomOptions(onLoad, originalOption, pageOptionSchema);
    };
    PoPageDynamicSearchComponent.ctorParameters = function () { return [
        { type: PoLanguageService },
        { type: PoPageCustomizationService },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        ViewChild(PoAdvancedFilterComponent, { static: true }),
        __metadata("design:type", PoAdvancedFilterComponent)
    ], PoPageDynamicSearchComponent.prototype, "poAdvancedFilter", void 0);
    PoPageDynamicSearchComponent = __decorate([
        Component({
            selector: 'po-page-dynamic-search',
            template: "<po-page-list\n  [p-actions]=\"actions\"\n  [p-breadcrumb]=\"breadcrumb\"\n  [p-disclaimer-group]=\"disclaimerGroup\"\n  [p-filter]=\"filterSettings\"\n  [p-title]=\"title\"\n>\n  <po-advanced-filter\n    [p-filters]=\"filters\"\n    [p-keep-filters]=\"keepFilters\"\n    [p-literals]=\"advancedFilterLiterals\"\n    (p-search-event)=\"onAdvancedSearch($event)\"\n  >\n  </po-advanced-filter>\n\n  <ng-content></ng-content>\n</po-page-list>\n"
        }),
        __metadata("design:paramtypes", [PoLanguageService,
            PoPageCustomizationService,
            ChangeDetectorRef])
    ], PoPageDynamicSearchComponent);
    return PoPageDynamicSearchComponent;
}(PoPageDynamicSearchBaseComponent));
export { PoPageDynamicSearchComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcGFnZS1keW5hbWljLXNlYXJjaC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG8tdWkvbmctdGVtcGxhdGVzLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tcGFnZS1keW5hbWljLXNlYXJjaC9wby1wYWdlLWR5bmFtaWMtc2VhcmNoLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczRixPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLGtCQUFrQixFQUNsQixrQkFBa0IsRUFDbEIsaUJBQWlCLEVBQ2pCLFlBQVksRUFDWiw2QkFBNkIsRUFDOUIsTUFBTSxzQkFBc0IsQ0FBQztBQUU5QixPQUFPLEVBQUUscUJBQXFCLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM3RSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxvRUFBb0UsQ0FBQztBQUVoSCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUM5RixPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQU8zRjs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFLSDtJQUFrRCxnREFBZ0M7SUFrQmhGLHNDQUNFLGVBQWtDLEVBQzFCLDBCQUFzRCxFQUN0RCxjQUFpQztRQUgzQyxZQUtFLGtCQUFNLGVBQWUsQ0FBQyxTQUN2QjtRQUpTLGdDQUEwQixHQUExQiwwQkFBMEIsQ0FBNEI7UUFDdEQsb0JBQWMsR0FBZCxjQUFjLENBQW1CO1FBbEIxQixzQkFBZ0IsR0FBc0I7WUFDckQsTUFBTSxFQUFFLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDO1lBQzFDLFNBQVMsRUFBRSxLQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQztZQUNqRCxXQUFXLEVBQUUsRUFBRTtZQUNmLEtBQUssRUFBRSxLQUFJLENBQUMsUUFBUSxDQUFDLG9CQUFvQjtTQUMxQyxDQUFDO1FBRWUscUJBQWUsR0FBaUI7WUFDL0MsTUFBTSxFQUFFLEtBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQztZQUNoQyxjQUFjLEVBQUUsS0FBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFJLENBQUM7WUFDaEQsV0FBVyxFQUFFLEtBQUksQ0FBQyxRQUFRLENBQUMsaUJBQWlCO1NBQzdDLENBQUM7O0lBVUYsQ0FBQztJQUVELHNCQUFJLHlEQUFlO2FBQW5CO1lBQ0UsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUM7UUFDakcsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSx3REFBYzthQUFsQjtZQUNFLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRS9HLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQztRQUNuRyxDQUFDOzs7T0FBQTtJQUVELCtDQUFRLEdBQVI7UUFDRSxJQUFJLENBQUMseUJBQXlCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNmLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDM0M7SUFDSCxDQUFDO0lBRUQsa0RBQVcsR0FBWDtRQUNFLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3pCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNyQztJQUNILENBQUM7SUFFRCxzREFBZSxHQUFmLFVBQWdCLE9BQTBDO1FBQ3hELElBQU0scUJBQXFCLEdBQUcsT0FBTzthQUNsQyxNQUFNLENBQUMsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLENBQUMsU0FBUyxFQUFoQixDQUFnQixDQUFDO2FBQ2xDLE1BQU0sQ0FBQyxVQUFDLElBQUksRUFBRSxPQUFPOztZQUNwQiw2QkFBWSxJQUFJLGFBQU8sR0FBQyxPQUFPLENBQUMsUUFBUSxJQUFHLE9BQU8sQ0FBQyxTQUFTLE9BQUs7UUFDbkUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRVQsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsTUFBTSxFQUFFO1lBQzdDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1NBQzlDO0lBQ0gsQ0FBQztJQUVELCtDQUFRLEdBQVIsVUFBUyxXQUFtQjtRQUE1QixpQkF5QkM7UUF4QkMsSUFBTSw0QkFBNEIsR0FBRztZQUNuQyxRQUFRLEVBQUUsUUFBUTtZQUNsQixLQUFLLEVBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsU0FBSSxXQUFhO1lBQ3pELEtBQUssRUFBRSxXQUFXO1NBQ25CLENBQUM7UUFFRixJQUFNLCtCQUErQixHQUFHLGNBQU0sZ0JBQ3pDLEtBQUksQ0FBQyxnQ0FBZ0MsRUFBRTtZQUMxQyw0QkFBNEI7WUFGZ0IsQ0FHN0MsQ0FBQztRQUVGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGFBQWE7WUFDcEQsQ0FBQyxDQUFDLCtCQUErQixFQUFFO1lBQ25DLENBQUMsQ0FBQyxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFFbkMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ3BDO1FBRUQsSUFBSSxJQUFJLENBQUMsV0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUMzQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLE9BQU8sSUFBSSxPQUFBLE9BQU8sT0FBTyxDQUFDLFNBQVMsRUFBeEIsQ0FBd0IsQ0FBQyxDQUFDO1NBQzNEO1FBRUQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQsdURBQWdCLEdBQWhCO1FBQ0UsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCx1REFBZ0IsR0FBaEIsVUFBaUIsT0FBTztRQUN0QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV6QixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRU8sdUVBQWdDLEdBQXhDO1FBQ0UsSUFBTSxtQkFBbUIsR0FBRyxRQUFRLENBQUM7UUFDckMsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxRQUFRLEtBQUssbUJBQW1CLEVBQXJDLENBQXFDLENBQUMsQ0FBQztJQUNqRyxDQUFDO0lBRU8saURBQVUsR0FBbEIsVUFBbUIsT0FBTztRQUN4QixJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV4RCxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFBLE9BQU87WUFDMUIsSUFBTSxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLENBQUMsUUFBUSxLQUFLLE9BQU8sQ0FBQyxRQUFRLEVBQWxDLENBQWtDLENBQUMsQ0FBQztZQUUzRixJQUFJLGdCQUFnQixFQUFFO2dCQUNwQixPQUFPLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQzthQUM1QztpQkFBTTtnQkFDTCxPQUFPLE9BQU8sQ0FBQyxTQUFTLENBQUM7YUFDMUI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyx1REFBZ0IsR0FBeEIsVUFBeUIsT0FBTztRQUM5QixPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUMsRUFBaUI7Z0JBQWpCLGtCQUFpQixFQUFoQixnQkFBUSxFQUFFLGFBQUs7WUFBTSxPQUFBLENBQUMsRUFBRSxRQUFRLFVBQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxDQUFDO1FBQXJCLENBQXFCLENBQUMsQ0FBQztJQUNuRixDQUFDO0lBRU8sZ0VBQXlCLEdBQWpDLFVBQWtDLEtBQVUsRUFBRSxXQUFnQjtRQUM1RCxJQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFeEUsSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFBLEtBQUs7WUFDN0IsSUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLENBQUMsS0FBSyxLQUFLLEtBQUssSUFBSSxNQUFNLEtBQUssS0FBSyxFQUExQyxDQUEwQyxDQUFDLENBQUM7WUFFL0YsSUFBSSxhQUFhLEVBQUU7Z0JBQ2pCLE9BQU8sYUFBYSxDQUFDLEtBQUssSUFBSSxhQUFhLENBQUMsS0FBSyxJQUFJLGFBQWEsQ0FBQzthQUNwRTtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTyxpREFBVSxHQUFsQixVQUFtQixJQUFZO1FBQzdCLElBQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUM3QyxJQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDOUMsSUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTVDLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQ2pGLENBQUM7SUFFTyxrRUFBMkIsR0FBbkMsVUFDRSxPQUFrRTtRQUVsRSxJQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUNwQyxVQUFDLE1BQU0sRUFBRSxJQUFJOztZQUFLLE9BQUEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLFlBQUksR0FBQyxJQUFJLENBQUMsUUFBUSxJQUFHLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFNBQVMsTUFBRztRQUF4RSxDQUF3RSxFQUMxRixFQUFFLENBQ0gsQ0FBQztRQUVGLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRztZQUN0QyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUN6QixPQUFPLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUM3QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQztJQUVPLHlEQUFrQixHQUExQixVQUEyQixNQUFpQyxFQUFFLFNBQWlCO1FBQzdFLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFDLEtBQXlCLElBQUssT0FBQSxLQUFLLENBQUMsUUFBUSxLQUFLLFNBQVMsRUFBNUIsQ0FBNEIsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFTyxpRUFBMEIsR0FBbEMsVUFBbUMsS0FBVSxFQUFFLEtBQVU7UUFDdkQsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLGtCQUFrQixDQUFDLElBQUksRUFBRTtZQUMxQyxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDL0I7UUFFRCxJQUFJLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxFQUFFO1lBQzFCLE9BQU8sSUFBSSxDQUFDLHlCQUF5QixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNyRDtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVPLHlEQUFrQixHQUExQixVQUEyQixVQUF5QztRQUMxRCxJQUFBLGtEQUFrQixDQUFnQjtRQUUxQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRU8sNkRBQXNCLEdBQTlCLFVBQStCLGtCQUF1QjtRQUNwRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFFTyw2REFBc0IsR0FBOUI7UUFDRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVPLHFEQUFjLEdBQXRCLFVBQXVCLE9BQU87UUFBOUIsaUJBcUJDO1FBcEJDLElBQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXhDLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBQSxRQUFRO1lBQ3pCLElBQU0sS0FBSyxHQUFHLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzlELElBQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLElBQUkscUJBQXFCLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ25FLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVoQyxJQUFNLGtDQUFrQyxHQUFHLEtBQUksQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFekYsSUFBSSxrQ0FBa0MsS0FBSyxFQUFFLEVBQUU7Z0JBQzdDLFdBQVcsQ0FBQyxJQUFJLENBQUM7b0JBQ2YsS0FBSyxFQUFLLEtBQUssVUFBSyxrQ0FBb0M7b0JBQ3hELFFBQVEsVUFBQTtvQkFDUixLQUFLLE9BQUE7aUJBQ04sQ0FBQyxDQUFDO2FBQ0o7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7SUFFTyw4REFBdUIsR0FBL0IsVUFBZ0MsTUFBb0M7UUFBcEUsaUJBSUM7UUFIQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFBLGdCQUFnQjtZQUNyRixPQUFBLEtBQUksQ0FBQywwQkFBMEIsQ0FBQyxpQ0FBaUMsQ0FBQyxLQUFJLEVBQUUsZ0JBQWdCLENBQUM7UUFBekYsQ0FBeUYsQ0FDMUYsQ0FBQztJQUNKLENBQUM7SUFFTyw4REFBdUIsR0FBL0IsVUFBZ0MsTUFBb0M7UUFDbEUsSUFBTSxjQUFjLEdBQStCO1lBQ2pELEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztZQUNqQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDckIsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQzNCLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztZQUNyQixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQ2xDLENBQUM7UUFFRixJQUFNLGdCQUFnQixHQUEyRDtZQUMvRSxNQUFNLEVBQUU7Z0JBQ047b0JBQ0UsUUFBUSxFQUFFLFNBQVM7b0JBQ25CLEtBQUssRUFBRSxJQUFJO29CQUNYLFdBQVcsRUFBRSxVQUFVO2lCQUN4QjtnQkFDRDtvQkFDRSxRQUFRLEVBQUUsU0FBUztvQkFDbkIsS0FBSyxFQUFFLElBQUk7b0JBQ1gsV0FBVyxFQUFFLE9BQU87aUJBQ3JCO2dCQUNEO29CQUNFLFFBQVEsRUFBRSxZQUFZO2lCQUN2QjtnQkFDRDtvQkFDRSxRQUFRLEVBQUUsT0FBTztpQkFDbEI7Z0JBQ0Q7b0JBQ0UsUUFBUSxFQUFFLGFBQWE7aUJBQ3hCO2dCQUNEO29CQUNFLFFBQVEsRUFBRSxlQUFlO2lCQUMxQjthQUNGO1NBQ0YsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLDBCQUEwQixDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUNwRyxDQUFDOztnQkFqUGtCLGlCQUFpQjtnQkFDRSwwQkFBMEI7Z0JBQ3RDLGlCQUFpQjs7SUFMYTtRQUF2RCxTQUFTLENBQUMseUJBQXlCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7a0NBQW1CLHlCQUF5QjswRUFBQztJQWhCekYsNEJBQTRCO1FBSnhDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx3QkFBd0I7WUFDbEMsc2NBQXNEO1NBQ3ZELENBQUM7eUNBb0JtQixpQkFBaUI7WUFDRSwwQkFBMEI7WUFDdEMsaUJBQWlCO09BckJoQyw0QkFBNEIsQ0FxUXhDO0lBQUQsbUNBQUM7Q0FBQSxBQXJRRCxDQUFrRCxnQ0FBZ0MsR0FxUWpGO1NBclFZLDRCQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgVmlld0NoaWxkLCBPbkluaXQsIE9uRGVzdHJveSwgQ2hhbmdlRGV0ZWN0b3JSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBQb0Rpc2NsYWltZXJHcm91cCxcbiAgUG9EeW5hbWljRmllbGRUeXBlLFxuICBQb0R5bmFtaWNGb3JtRmllbGQsXG4gIFBvTGFuZ3VhZ2VTZXJ2aWNlLFxuICBQb1BhZ2VGaWx0ZXIsXG4gIFBvRGlzY2xhaW1lckdyb3VwUmVtb3ZlQWN0aW9uXG59IGZyb20gJ0Bwby11aS9uZy1jb21wb25lbnRzJztcblxuaW1wb3J0IHsgY2FwaXRhbGl6ZUZpcnN0TGV0dGVyLCBnZXRCcm93c2VyTGFuZ3VhZ2UgfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvUGFnZUN1c3RvbWl6YXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tcGFnZS1jdXN0b21pemF0aW9uL3BvLXBhZ2UtY3VzdG9taXphdGlvbi5zZXJ2aWNlJztcblxuaW1wb3J0IHsgUG9BZHZhbmNlZEZpbHRlckNvbXBvbmVudCB9IGZyb20gJy4vcG8tYWR2YW5jZWQtZmlsdGVyL3BvLWFkdmFuY2VkLWZpbHRlci5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9QYWdlRHluYW1pY1NlYXJjaEJhc2VDb21wb25lbnQgfSBmcm9tICcuL3BvLXBhZ2UtZHluYW1pYy1zZWFyY2gtYmFzZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9QYWdlRHluYW1pY1NlYXJjaE9wdGlvbnMgfSBmcm9tICcuL3BvLXBhZ2UtZHluYW1pYy1zZWFyY2gtb3B0aW9ucy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9QYWdlRHluYW1pY09wdGlvbnNTY2hlbWEgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcyc7XG5pbXBvcnQgeyBQb1BhZ2VEeW5hbWljU2VhcmNoRmlsdGVycyB9IGZyb20gJy4vcG8tcGFnZS1keW5hbWljLXNlYXJjaC1maWx0ZXJzLmludGVyZmFjZSc7XG5cbnR5cGUgVXJsT3JQb0N1c3RvbWl6YXRpb25GdW5jdGlvbiA9IHN0cmluZyB8ICgoKSA9PiBQb1BhZ2VEeW5hbWljU2VhcmNoT3B0aW9ucyk7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFBvUGFnZUR5bmFtaWNTZWFyY2hCYXNlQ29tcG9uZW50XG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tcGFnZS1keW5hbWljLXNlYXJjaC1iYXNpY1wiIHRpdGxlPVwiUE8gUGFnZSBEeW5hbWljIFNlYXJjaCBCYXNpY1wiPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tcGFnZS1keW5hbWljLXNlYXJjaC1iYXNpYy9zYW1wbGUtcG8tcGFnZS1keW5hbWljLXNlYXJjaC1iYXNpYy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1wYWdlLWR5bmFtaWMtc2VhcmNoLWJhc2ljL3NhbXBsZS1wby1wYWdlLWR5bmFtaWMtc2VhcmNoLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLXBhZ2UtZHluYW1pYy1zZWFyY2gtaGlyaW5nLXByb2Nlc3Nlc1wiIHRpdGxlPVwiUE8gUGFnZSBEeW5hbWljIFNlYXJjaCAtIEhpcmluZyBwcm9jZXNzZXNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXBhZ2UtZHluYW1pYy1zZWFyY2gtaGlyaW5nLXByb2Nlc3Nlcy9zYW1wbGUtcG8tcGFnZS1keW5hbWljLXNlYXJjaC1oaXJpbmctcHJvY2Vzc2VzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXBhZ2UtZHluYW1pYy1zZWFyY2gtaGlyaW5nLXByb2Nlc3Nlcy9zYW1wbGUtcG8tcGFnZS1keW5hbWljLXNlYXJjaC1oaXJpbmctcHJvY2Vzc2VzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1wYWdlLWR5bmFtaWMtc2VhcmNoLWhpcmluZy1wcm9jZXNzZXMvc2FtcGxlLXBvLXBhZ2UtZHluYW1pYy1zZWFyY2gtaGlyaW5nLXByb2Nlc3Nlcy5zZXJ2aWNlLnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tcGFnZS1keW5hbWljLXNlYXJjaCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1wYWdlLWR5bmFtaWMtc2VhcmNoLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb1BhZ2VEeW5hbWljU2VhcmNoQ29tcG9uZW50IGV4dGVuZHMgUG9QYWdlRHluYW1pY1NlYXJjaEJhc2VDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgbG9hZFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgX2Rpc2NsYWltZXJHcm91cDogUG9EaXNjbGFpbWVyR3JvdXAgPSB7XG4gICAgcmVtb3ZlOiB0aGlzLm9uUmVtb3ZlRGlzY2xhaW1lci5iaW5kKHRoaXMpLFxuICAgIHJlbW92ZUFsbDogdGhpcy5vblJlbW92ZUFsbERpc2NsYWltZXJzLmJpbmQodGhpcyksXG4gICAgZGlzY2xhaW1lcnM6IFtdLFxuICAgIHRpdGxlOiB0aGlzLmxpdGVyYWxzLmRpc2NsYWltZXJHcm91cFRpdGxlXG4gIH07XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfZmlsdGVyU2V0dGluZ3M6IFBvUGFnZUZpbHRlciA9IHtcbiAgICBhY3Rpb246IHRoaXMub25BY3Rpb24uYmluZCh0aGlzKSxcbiAgICBhZHZhbmNlZEFjdGlvbjogdGhpcy5vbkFkdmFuY2VkQWN0aW9uLmJpbmQodGhpcyksXG4gICAgcGxhY2Vob2xkZXI6IHRoaXMubGl0ZXJhbHMuc2VhcmNoUGxhY2Vob2xkZXJcbiAgfTtcblxuICBAVmlld0NoaWxkKFBvQWR2YW5jZWRGaWx0ZXJDb21wb25lbnQsIHsgc3RhdGljOiB0cnVlIH0pIHBvQWR2YW5jZWRGaWx0ZXI6IFBvQWR2YW5jZWRGaWx0ZXJDb21wb25lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgbGFuZ3VhZ2VTZXJ2aWNlOiBQb0xhbmd1YWdlU2VydmljZSxcbiAgICBwcml2YXRlIHBvUGFnZUN1c3RvbWl6YXRpb25TZXJ2aWNlOiBQb1BhZ2VDdXN0b21pemF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZlxuICApIHtcbiAgICBzdXBlcihsYW5ndWFnZVNlcnZpY2UpO1xuICB9XG5cbiAgZ2V0IGRpc2NsYWltZXJHcm91cCgpIHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5fZGlzY2xhaW1lckdyb3VwLCB7IHRpdGxlOiB0aGlzLmxpdGVyYWxzLmRpc2NsYWltZXJHcm91cFRpdGxlIH0pO1xuICB9XG5cbiAgZ2V0IGZpbHRlclNldHRpbmdzKCkge1xuICAgIHRoaXMuX2ZpbHRlclNldHRpbmdzLmFkdmFuY2VkQWN0aW9uID0gdGhpcy5maWx0ZXJzLmxlbmd0aCA9PT0gMCA/IHVuZGVmaW5lZCA6IHRoaXMub25BZHZhbmNlZEFjdGlvbi5iaW5kKHRoaXMpO1xuXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX2ZpbHRlclNldHRpbmdzLCB7IHBsYWNlaG9sZGVyOiB0aGlzLmxpdGVyYWxzLnNlYXJjaFBsYWNlaG9sZGVyIH0pO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5zZXRBZHZhbmNlZEZpbHRlckxpdGVyYWxzKHRoaXMubGl0ZXJhbHMpO1xuICAgIGlmICh0aGlzLm9uTG9hZCkge1xuICAgICAgdGhpcy5sb2FkT3B0aW9uc09uSW5pdGlhbGl6ZSh0aGlzLm9uTG9hZCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMubG9hZFN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5sb2FkU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgb25DaGFuZ2VGaWx0ZXJzKGZpbHRlcnM6IEFycmF5PFBvUGFnZUR5bmFtaWNTZWFyY2hGaWx0ZXJzPikge1xuICAgIGNvbnN0IGZpbHRlck9iamVjdFdpdGhWYWx1ZSA9IGZpbHRlcnNcbiAgICAgIC5maWx0ZXIoZmlsdGVyID0+IGZpbHRlci5pbml0VmFsdWUpXG4gICAgICAucmVkdWNlKChwcmV2LCBjdXJyZW50KSA9PiB7XG4gICAgICAgIHJldHVybiB7IC4uLnByZXYsIC4uLnsgW2N1cnJlbnQucHJvcGVydHldOiBjdXJyZW50LmluaXRWYWx1ZSB9IH07XG4gICAgICB9LCB7fSk7XG5cbiAgICBpZiAoT2JqZWN0LmtleXMoZmlsdGVyT2JqZWN0V2l0aFZhbHVlKS5sZW5ndGgpIHtcbiAgICAgIHRoaXMub25BZHZhbmNlZFNlYXJjaChmaWx0ZXJPYmplY3RXaXRoVmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIG9uQWN0aW9uKHF1aWNrRmlsdGVyOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkaXNjbGFpbWVyUXVpY2tTZWFyY2hVcGRhdGVkID0ge1xuICAgICAgcHJvcGVydHk6ICdzZWFyY2gnLFxuICAgICAgbGFiZWw6IGAke3RoaXMubGl0ZXJhbHMucXVpY2tTZWFyY2hMYWJlbH0gJHtxdWlja0ZpbHRlcn1gLFxuICAgICAgdmFsdWU6IHF1aWNrRmlsdGVyXG4gICAgfTtcblxuICAgIGNvbnN0IGdldERpc2NsYWltZXJzV2l0aENvbmNhdEZpbHRlcnMgPSAoKSA9PiBbXG4gICAgICAuLi50aGlzLmdldERpc2NsYWltZXJzV2l0aG91dFF1aWNrU2VhcmNoKCksXG4gICAgICBkaXNjbGFpbWVyUXVpY2tTZWFyY2hVcGRhdGVkXG4gICAgXTtcblxuICAgIHRoaXMuX2Rpc2NsYWltZXJHcm91cC5kaXNjbGFpbWVycyA9IHRoaXMuY29uY2F0RmlsdGVyc1xuICAgICAgPyBnZXREaXNjbGFpbWVyc1dpdGhDb25jYXRGaWx0ZXJzKClcbiAgICAgIDogW2Rpc2NsYWltZXJRdWlja1NlYXJjaFVwZGF0ZWRdO1xuXG4gICAgaWYgKHRoaXMucXVpY2tTZWFyY2gub2JzZXJ2ZXJzICYmIHRoaXMucXVpY2tTZWFyY2gub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMucXVpY2tTZWFyY2guZW1pdChxdWlja0ZpbHRlcik7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMua2VlcEZpbHRlcnMgJiYgIXRoaXMuY29uY2F0RmlsdGVycykge1xuICAgICAgdGhpcy5maWx0ZXJzLmZvckVhY2goZWxlbWVudCA9PiBkZWxldGUgZWxlbWVudC5pbml0VmFsdWUpO1xuICAgIH1cblxuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgb25BZHZhbmNlZEFjdGlvbigpIHtcbiAgICB0aGlzLnBvQWR2YW5jZWRGaWx0ZXIub3BlbigpO1xuICB9XG5cbiAgb25BZHZhbmNlZFNlYXJjaChmaWx0ZXJzKSB7XG4gICAgdGhpcy5fZGlzY2xhaW1lckdyb3VwLmRpc2NsYWltZXJzID0gdGhpcy5zZXREaXNjbGFpbWVycyhmaWx0ZXJzKTtcblxuICAgIHRoaXMuc2V0RmlsdGVycyhmaWx0ZXJzKTtcblxuICAgIHRoaXMuYWR2YW5jZWRTZWFyY2guZW1pdChmaWx0ZXJzKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGlzY2xhaW1lcnNXaXRob3V0UXVpY2tTZWFyY2goKSB7XG4gICAgY29uc3QgcXVpY2tTZWFyY2hQcm9wZXJ0eSA9ICdzZWFyY2gnO1xuICAgIHJldHVybiB0aGlzLl9kaXNjbGFpbWVyR3JvdXAuZGlzY2xhaW1lcnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5wcm9wZXJ0eSAhPT0gcXVpY2tTZWFyY2hQcm9wZXJ0eSk7XG4gIH1cblxuICBwcml2YXRlIHNldEZpbHRlcnMoZmlsdGVycykge1xuICAgIGNvbnN0IGZvcm1hdHRlZEZpbHRlcnMgPSB0aGlzLmNvbnZlcnRUb0ZpbHRlcnMoZmlsdGVycyk7XG5cbiAgICB0aGlzLmZpbHRlcnMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgIGNvbnN0IGNvbXBhdGlibGVPYmplY3QgPSBmb3JtYXR0ZWRGaWx0ZXJzLmZpbmQoaXRlbSA9PiBpdGVtLnByb3BlcnR5ID09PSBlbGVtZW50LnByb3BlcnR5KTtcblxuICAgICAgaWYgKGNvbXBhdGlibGVPYmplY3QpIHtcbiAgICAgICAgZWxlbWVudC5pbml0VmFsdWUgPSBjb21wYXRpYmxlT2JqZWN0LnZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVsZXRlIGVsZW1lbnQuaW5pdFZhbHVlO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9GaWx0ZXJzKGZpbHRlcnMpIHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMoZmlsdGVycykubWFwKChbcHJvcGVydHksIHZhbHVlXSkgPT4gKHsgcHJvcGVydHksIHZhbHVlIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlEaXNjbGFpbWVyTGFiZWxWYWx1ZShmaWVsZDogYW55LCBmaWx0ZXJWYWx1ZTogYW55KSB7XG4gICAgY29uc3QgdmFsdWVzID0gQXJyYXkuaXNBcnJheShmaWx0ZXJWYWx1ZSkgPyBmaWx0ZXJWYWx1ZSA6IFtmaWx0ZXJWYWx1ZV07XG5cbiAgICBjb25zdCBsYWJlbHMgPSB2YWx1ZXMubWFwKHZhbHVlID0+IHtcbiAgICAgIGNvbnN0IGZpbHRlcmVkRmllbGQgPSBmaWVsZC5vcHRpb25zLmZpbmQob3B0aW9uID0+IG9wdGlvbi52YWx1ZSA9PT0gdmFsdWUgfHwgb3B0aW9uID09PSB2YWx1ZSk7XG5cbiAgICAgIGlmIChmaWx0ZXJlZEZpZWxkKSB7XG4gICAgICAgIHJldHVybiBmaWx0ZXJlZEZpZWxkLmxhYmVsIHx8IGZpbHRlcmVkRmllbGQudmFsdWUgfHwgZmlsdGVyZWRGaWVsZDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBsYWJlbHMuam9pbignLCAnKTtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0RGF0ZShkYXRlOiBzdHJpbmcpIHtcbiAgICBjb25zdCB5ZWFyID0gcGFyc2VJbnQoZGF0ZS5zdWJzdHIoMCwgNCksIDEwKTtcbiAgICBjb25zdCBtb250aCA9IHBhcnNlSW50KGRhdGUuc3Vic3RyKDUsIDIpLCAxMCk7XG4gICAgY29uc3QgZGF5ID0gcGFyc2VJbnQoZGF0ZS5zdWJzdHIoOCwgMiksIDEwKTtcblxuICAgIHJldHVybiBuZXcgRGF0ZSh5ZWFyLCBtb250aCAtIDEsIGRheSkudG9Mb2NhbGVEYXRlU3RyaW5nKGdldEJyb3dzZXJMYW5ndWFnZSgpKTtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0QXJyYXlUb09iamVjdEtleVZhbHVlKFxuICAgIGZpbHRlcnM6IEFycmF5PHsgcHJvcGVydHk6IHN0cmluZzsgdmFsdWU/OiBhbnk7IGluaXRWYWx1ZT86IGFueSB9PlxuICApOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHtcbiAgICBjb25zdCBmb3JtYXR0ZWRPYmplY3QgPSBmaWx0ZXJzLnJlZHVjZShcbiAgICAgIChyZXN1bHQsIGl0ZW0pID0+IE9iamVjdC5hc3NpZ24ocmVzdWx0LCB7IFtpdGVtLnByb3BlcnR5XTogaXRlbS52YWx1ZSB8fCBpdGVtLmluaXRWYWx1ZSB9KSxcbiAgICAgIHt9XG4gICAgKTtcblxuICAgIE9iamVjdC5rZXlzKGZvcm1hdHRlZE9iamVjdCkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKCFmb3JtYXR0ZWRPYmplY3Rba2V5XSkge1xuICAgICAgICBkZWxldGUgZm9ybWF0dGVkT2JqZWN0W2tleV07XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZm9ybWF0dGVkT2JqZWN0O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaWVsZEJ5UHJvcGVydHkoZmllbGRzOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+LCBmaWVsZE5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiBmaWVsZHMuZmluZCgoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCkgPT4gZmllbGQucHJvcGVydHkgPT09IGZpZWxkTmFtZSk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpbHRlclZhbHVlVG9EaXNjbGFpbWVyKGZpZWxkOiBhbnksIHZhbHVlOiBhbnkpIHtcbiAgICBpZiAoZmllbGQudHlwZSA9PT0gUG9EeW5hbWljRmllbGRUeXBlLkRhdGUpIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdERhdGUodmFsdWUpO1xuICAgIH1cblxuICAgIGlmIChmaWVsZC5vcHRpb25zICYmIHZhbHVlKSB7XG4gICAgICByZXR1cm4gdGhpcy5hcHBseURpc2NsYWltZXJMYWJlbFZhbHVlKGZpZWxkLCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBvblJlbW92ZURpc2NsYWltZXIocmVtb3ZlRGF0YTogUG9EaXNjbGFpbWVyR3JvdXBSZW1vdmVBY3Rpb24pIHtcbiAgICBjb25zdCB7IGN1cnJlbnREaXNjbGFpbWVycyB9ID0gcmVtb3ZlRGF0YTtcblxuICAgIHRoaXMuZW1pdENoYW5nZXNEaXNjbGFpbWVycyhjdXJyZW50RGlzY2xhaW1lcnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBlbWl0Q2hhbmdlc0Rpc2NsYWltZXJzKGN1cnJlbnREaXNjbGFpbWVyczogYW55KSB7XG4gICAgdGhpcy5jaGFuZ2VEaXNjbGFpbWVycy5lbWl0KGN1cnJlbnREaXNjbGFpbWVycyk7XG4gICAgdGhpcy5zZXRGaWx0ZXJzKHRoaXMuZm9ybWF0QXJyYXlUb09iamVjdEtleVZhbHVlKGN1cnJlbnREaXNjbGFpbWVycykpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblJlbW92ZUFsbERpc2NsYWltZXJzKCkge1xuICAgIHRoaXMuZW1pdENoYW5nZXNEaXNjbGFpbWVycyhbXSk7XG4gIH1cblxuICBwcml2YXRlIHNldERpc2NsYWltZXJzKGZpbHRlcnMpIHtcbiAgICBjb25zdCBkaXNjbGFpbWVycyA9IFtdO1xuICAgIGNvbnN0IHByb3BlcnRpZXMgPSBPYmplY3Qua2V5cyhmaWx0ZXJzKTtcblxuICAgIHByb3BlcnRpZXMuZm9yRWFjaChwcm9wZXJ0eSA9PiB7XG4gICAgICBjb25zdCBmaWVsZCA9IHRoaXMuZ2V0RmllbGRCeVByb3BlcnR5KHRoaXMuZmlsdGVycywgcHJvcGVydHkpO1xuICAgICAgY29uc3QgbGFiZWwgPSBmaWVsZC5sYWJlbCB8fCBjYXBpdGFsaXplRmlyc3RMZXR0ZXIoZmllbGQucHJvcGVydHkpO1xuICAgICAgY29uc3QgdmFsdWUgPSBmaWx0ZXJzW3Byb3BlcnR5XTtcblxuICAgICAgY29uc3QgdmFsdWVEaXNwbGF5ZWRPblRoZURpc2NsYWltZXJMYWJlbCA9IHRoaXMuZ2V0RmlsdGVyVmFsdWVUb0Rpc2NsYWltZXIoZmllbGQsIHZhbHVlKTtcblxuICAgICAgaWYgKHZhbHVlRGlzcGxheWVkT25UaGVEaXNjbGFpbWVyTGFiZWwgIT09ICcnKSB7XG4gICAgICAgIGRpc2NsYWltZXJzLnB1c2goe1xuICAgICAgICAgIGxhYmVsOiBgJHtsYWJlbH06ICR7dmFsdWVEaXNwbGF5ZWRPblRoZURpc2NsYWltZXJMYWJlbH1gLFxuICAgICAgICAgIHByb3BlcnR5LFxuICAgICAgICAgIHZhbHVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGRpc2NsYWltZXJzO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkT3B0aW9uc09uSW5pdGlhbGl6ZShvbkxvYWQ6IFVybE9yUG9DdXN0b21pemF0aW9uRnVuY3Rpb24pIHtcbiAgICB0aGlzLmxvYWRTdWJzY3JpcHRpb24gPSB0aGlzLmdldFBvRHluYW1pY1BhZ2VPcHRpb25zKG9uTG9hZCkuc3Vic2NyaWJlKHJlc3BvbnNlUG9PcHRpb24gPT5cbiAgICAgIHRoaXMucG9QYWdlQ3VzdG9taXphdGlvblNlcnZpY2UuY2hhbmdlT3JpZ2luYWxPcHRpb25zVG9OZXdPcHRpb25zKHRoaXMsIHJlc3BvbnNlUG9PcHRpb24pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UG9EeW5hbWljUGFnZU9wdGlvbnMob25Mb2FkOiBVcmxPclBvQ3VzdG9taXphdGlvbkZ1bmN0aW9uKTogT2JzZXJ2YWJsZTxQb1BhZ2VEeW5hbWljU2VhcmNoT3B0aW9ucz4ge1xuICAgIGNvbnN0IG9yaWdpbmFsT3B0aW9uOiBQb1BhZ2VEeW5hbWljU2VhcmNoT3B0aW9ucyA9IHtcbiAgICAgIHRpdGxlOiB0aGlzLnRpdGxlLFxuICAgICAgYWN0aW9uczogdGhpcy5hY3Rpb25zLFxuICAgICAgYnJlYWRjcnVtYjogdGhpcy5icmVhZGNydW1iLFxuICAgICAgZmlsdGVyczogdGhpcy5maWx0ZXJzLFxuICAgICAga2VlcEZpbHRlcnM6IHRoaXMua2VlcEZpbHRlcnMsXG4gICAgICBjb25jYXRGaWx0ZXJzOiB0aGlzLmNvbmNhdEZpbHRlcnNcbiAgICB9O1xuXG4gICAgY29uc3QgcGFnZU9wdGlvblNjaGVtYTogUG9QYWdlRHluYW1pY09wdGlvbnNTY2hlbWE8UG9QYWdlRHluYW1pY1NlYXJjaE9wdGlvbnM+ID0ge1xuICAgICAgc2NoZW1hOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lUHJvcDogJ2ZpbHRlcnMnLFxuICAgICAgICAgIG1lcmdlOiB0cnVlLFxuICAgICAgICAgIGtleUZvck1lcmdlOiAncHJvcGVydHknXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lUHJvcDogJ2FjdGlvbnMnLFxuICAgICAgICAgIG1lcmdlOiB0cnVlLFxuICAgICAgICAgIGtleUZvck1lcmdlOiAnbGFiZWwnXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lUHJvcDogJ2JyZWFkY3J1bWInXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lUHJvcDogJ3RpdGxlJ1xuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZVByb3A6ICdrZWVwRmlsdGVycydcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIG5hbWVQcm9wOiAnY29uY2F0RmlsdGVycydcbiAgICAgICAgfVxuICAgICAgXVxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5wb1BhZ2VDdXN0b21pemF0aW9uU2VydmljZS5nZXRDdXN0b21PcHRpb25zKG9uTG9hZCwgb3JpZ2luYWxPcHRpb24sIHBhZ2VPcHRpb25TY2hlbWEpO1xuICB9XG59XG4iXX0=